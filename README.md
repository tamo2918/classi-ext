# Classi拡張くん - Chrome拡張機能

Classi拡張くんは、Classiをもっと快適に使うための非公式 Chrome 拡張機能です。  
PDFを同じタブ内でオーバーレイ表示したり、Dark Reader ベースのダークモードを切り替えたりできます。必要な機能だけをオン・オフできるよう、拡張アイコンのポップアップから簡単に操作できます。

## 主な機能

- **PDFオーバーレイ表示**: PDFリンクをクリックすると、その場でモーダル表示。別タブを開かずに資料を確認できます。
- **ダークモード**: Classi全体をダーク化して夜間でも目に優しい表示に。
- **Spotlight風検索**: macOSのSpotlight風の美しい検索UI。右下の検索ボタンまたは `Cmd+K` (Mac) / `Ctrl+K` (Windows) で起動できます。
  - 全グループを横断して投稿を検索
  - キーワードのハイライト表示
  - リアルタイム検索（デバウンス処理付き）
  - シンプルで直感的な操作
- **サイドバー折りたたみ**: macOS Dock風のスマートなサイドバー折りたたみ機能。
  - 画面を広く使える
  - 左上の紫色ボタンでサイドバーを開く
  - `Cmd+B` (Mac) / `Ctrl+B` (Windows) でトグル
  - 状態は自動保存され、ページリロード時も維持
  - 既存のサイドバー機能（選択、スクロールなど）は完全に保持
- **トグル制御**: ポップアップからPDFオーバーレイ／ダークモードの両方をワンクリックで切り替え。設定は `chrome.storage.sync` に保存され、デバイス間で同期されます。
- **スマートな閉じ方**: バツボタン、ESCキー、背景クリックでモーダルをすぐ閉じられます。
- **ダウンロード抑制**: `Content-Disposition` を `inline` に書き換えて自動ダウンロードを防止。必要なときだけPDFビューアから保存可能です。

## 仕組み

### PDFオーバーレイ (content.js + styles.css)
- Content ScriptがPDFリンクのクリックを捕捉し、デフォルト動作を止めてモーダルを生成。
- クリック、ESC、背景操作で閉じる処理やスクロール固定を実装。
- 設定に応じてイベントリスナーを動的に登録／解除。

### ダークモード (darkreader.js + content.js)
- Dark Reader のビルド済みスクリプトを同梱し、Content Scriptから設定を適用。
- サイトのCSP制限を避けるため、背景の Service Worker (`background.js`) を通じてリソースをフェッチ。

### Spotlight風検索 (search-overlay.js + search-overlay.css)
- Classi APIを利用して全グループを横断検索
- 右下の浮遊検索ボタン（FAB）で簡単アクセス
- キーボードショートカット（`Cmd+K` / `Ctrl+K`）に対応
- 半透明のオーバーレイとスムーズなアニメーション
- リアルタイム検索とキーワードハイライト表示

### サイドバー折りたたみ (sidebar-toggle.js + sidebar-toggle.css)
- macOS Dock風の直感的な操作
- 左上の紫色ボタンでサイドバーを開く
- CSS transitionによる滑らかなアニメーション
- 状態を`chrome.storage.local`に保存
- 既存のAngularJS機能を一切変更せず、CSSクラスの追加のみで実装
- キーボードショートカット（`Cmd+B` / `Ctrl+B`、ESC）対応

### ヘッダー制御 (rules.json)
- `declarativeNetRequest` を使って `Content-Disposition: inline` に書き換え、ChromeがPDFを直接表示できるようにします。

## インストール手順

1. このリポジトリ（フォルダ）を任意の場所に保存します。
2. Chromeで `chrome://extensions/` を開き、右上の「デベロッパーモード」をオン。
3. 「パッケージ化されていない拡張機能を読み込む」をクリックし、このフォルダ（例: `classi-ext`）を選択。
4. Classi のページを開き、拡張アイコンをクリックしてトグルが表示されることを確認。

## 使い方

1. ClassiにログインしてPDFリンクを開く。
2. 必要に応じてポップアップから
   - 「PDFオーバーレイ表示」をオン → クリックしたPDFがモーダルで開きます。
   - 「ダークモード」をオン → Dark Reader がClassi全体に適用されます。
3. PDFモーダルは×ボタン、ESCキー、背景クリックで閉じられます。
4. **検索機能の使い方**:
   - 校内グループページで右下の検索ボタンをクリック、または `Cmd+K` (Mac) / `Ctrl+K` (Windows) を押す
   - 検索ボックスにキーワードや投稿者名を入力
   - 検索結果がリアルタイムで表示されます
   - 結果をクリックすると該当の投稿に移動します
   - ESCキーまたは背景をクリックして閉じます

## 設定・権限

- `declarativeNetRequest`: レスポンスヘッダーを書き換えるために使用。
- `storage`: トグル設定を同期するために使用。
- `https://*.classi.jp/*`: Classiドメイン内でのみ実行されるように制限。

## ファイル構成

```
classi-ext/
├── manifest.json        # 拡張機能の設定
├── background.js        # Dark Reader 用フェッチプロキシ
├── content.js           # PDFオーバーレイとダークモード制御
├── darkreader.js        # Dark Reader ライブラリ
├── search-overlay.js    # Spotlight風検索機能
├── search-overlay.css   # 検索UIのスタイル
├── popup.html|css|js    # トグル用ポップアップUI
├── rules.json           # declarativeNetRequestルール
├── styles.css           # PDFオーバーレイのスタイル
├── icon*.png / icon.svg # 拡張アイコン
└── README.md            # このファイル
```

## トラブルシューティング

- **PDFがモーダルで開かない**
  拡張が有効か確認し、ページをリロード。必要なら拡張を再読み込みしてみてください。

- **設定を切り替えても反映されない**
  Chromeのポップアップは非Classiページだとメッセージを送れません。Classiのタブをアクティブにしてから操作してください。

- **Dark Readerでエラーが出る**
  拡張を再読み込みし、Classiのタブをリロードしてください。依然として発生する場合はコンソールのエラーメッセージを確認してください。

- **検索機能が動作しない**
  校内グループページ（`/group2`）でのみ動作します。拡張を再読み込みし、ページをリロードしてください。

- **検索ボタンが表示されない**
  拡張が正しくインストールされているか確認してください。コンソール（F12）でエラーメッセージを確認できます。

- **検索結果が表示されない**
  Classi APIへのアクセス権限があることを確認してください。ログイン状態を確認し、必要に応じて再ログインしてください。

## 技術情報

- **Manifest Version**: 3
- **対象URL**: `https://*.classi.jp/*`
- **Dark Reader バージョン**: 4.9.95
- **対応ブラウザ**: 最新版の Google Chrome

## ライセンス

MIT License

---

Classi拡張くんはClassi公式のツールではありません。利用は自己責任でお願いします。
